Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"

  # Configure Splunk server
  config.vm.define "splunk" do |splunk|
    splunk.vm.hostname = "splunk"
    splunk.vm.provider "qemu" do |sp|
      sp.arch = "x86_64"
      sp.machine = "q35"
      sp.cpu = "qemu64"
      sp.net_device = "virtio-net-pci"
    end
    splunk.vm.network "private_network", type: "dhcp"

    splunk.vm.provider "virtualbox" do |vb|
      vb.memory = "2048"
      vb.cpus = 2
    end

    splunk.vm.network "forwarded_port", guest: 22, host: 50230, id: "ssh"
    splunk.vm.network "forwarded_port", guest: 8000, host: 8081, id: "splunk_web"
    splunk.vm.network "forwarded_port", guest: 8089, host: 8091, id: "splunk_mgmt"
    splunk.vm.network "forwarded_port", guest: 9997, host: 9998, id: "splunk_receiver"
    splunk.vm.synced_folder "./splunk_files", "/vagrant/splunk_files", type: "rsync"

    splunk.vm.provision "shell", inline: <<-SHELL
          set -euxo pipefail
      export DEBIAN_FRONTEND=noninteractive
      apt-get update -y
      apt-get install -y wget

      SPLUNK_DEB="/vagrant/splunk_files/splunk-9.4.0-6b4ebe426ca6-linux-amd64.deb"
      if [ ! -f ${SPLUNK_DEB} ]; then
        wget -O ${SPLUNK_DEB} "https://download.splunk.com/products/splunk/releases/9.4.0/linux/splunk-9.4.0-6b4ebe426ca6-linux-amd64.deb"
      fi

      dpkg -i ${SPLUNK_DEB} || apt-get install -f -y

      mkdir -p /opt/splunk/etc/system/local
      echo "[user_info]" > /opt/splunk/etc/system/local/user-seed.conf
      echo "USERNAME=admin" >> /opt/splunk/etc/system/local/user-seed.conf
      echo "PASSWORD=changeme123" >> /opt/splunk/etc/system/local/user-seed.conf

      echo "[sslConfig]" > /opt/splunk/etc/system/local/server.conf
      echo "cliVerifyServerName = true" >> /opt/splunk/etc/system/local/server.conf

      sed -i 's/^#\\?PYTHONHTTPSVERIFY=.*$/PYTHONHTTPSVERIFY=1/' /opt/splunk/etc/splunk-launch.conf

      # Enable receiving on port 9997
      /opt/splunk/bin/splunk enable listen 9997 --accept-license --answer-yes --no-prompt
      /opt/splunk/bin/splunk enable boot-start --accept-license --answer-yes --no-prompt
      /opt/splunk/bin/splunk start --accept-license --answer-yes --no-prompt
      # Your provision script for splunk
    SHELL
  end

  # Configure Splunk Forwarder
  config.vm.define "splunk_forwarder" do |forwarder|
    forwarder.vm.hostname = "splunk-forwarder"
    forwarder.vm.provider "qemu" do |fw|
      fw.arch = "x86_64"
      fw.machine = "q35"
      fw.cpu = "qemu64"
      fw.net_device = "virtio-net-pci"
    end
    forwarder.vm.network "private_network", type: "dhcp"
    forwarder.vm.network "forwarded_port", guest: 22, host: 50232, id: "ssh"

    forwarder.vm.synced_folder "./splunk_files", "/vagrant/splunk_files", type: "rsync"

    forwarder.vm.provision "shell", inline: <<-SHELL
      set -euxo pipefail
      SPLUNK_FORWARDER_DEB="/vagrant/splunk_files/splunkforwarder-9.4.0-6b4ebe426ca6-linux-amd64.deb"

      if [ ! -f $SPLUNK_FORWARDER_DEB ]; then
        curl -o $SPLUNK_FORWARDER_DEB https://download.splunk.com/products/universalforwarder/releases/9.4.0/linux/splunkforwarder-9.4.0-6b4ebe426ca6-linux-amd64.deb
      fi

      dpkg -i $SPLUNK_FORWARDER_DEB || apt-get install -f -y

      # /opt/splunkforwarder/bin/splunk start --accept-license --answer-yes --no-prompt
      # /opt/splunkforwarder/bin/splunk enable boot-start --accept-license --no-prompt
      # /opt/splunkforwarder/bin/splunk add forward-server localhost:9997 -auth admin:changeme123 --no-prompt
      # /opt/splunkforwarder/bin/splunk restart --no-prompt      # Your provision script for splunk_forwarder
    SHELL
  end
end
